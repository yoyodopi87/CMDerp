<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMD é›²ç«¯é€²éŠ·å­˜ç³»çµ±</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --cmd-dark: #2c3e50; --cmd-in: #27ae60; --cmd-out: #e67e22; --cmd-red: #e74c3c; --cmd-gold: #f1c40f; --cmd-blue: #3498db; --cmd-purple: #9b59b6; --cmd-excel: #1d6f42; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1450px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .page { display: none; } .active { display: block; }
        #loginPage { text-align: center; padding: 80px 20px; }
        .login-box { max-width: 420px; margin: auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 1px solid #eee; }
        .login-input-group { margin-bottom: 20px; text-align: left; }
        .login-input-group label { display: block; font-weight: bold; margin-bottom: 8px; }
        .login-select, .login-password { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 15px; background: var(--cmd-dark); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        header { border-bottom: 3px solid var(--cmd-dark); margin-bottom: 20px; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .user-badge { font-size: 13px; background: #e9ecef; padding: 5px 12px; border-radius: 20px; color: var(--cmd-dark); font-weight: bold; }
        #cloudStatus { font-size: 12px; padding: 4px 10px; border-radius: 4px; font-weight: bold; }
        .status-ok { background: #d4edda; color: #155724; }
        .status-err { background: #f8d7da; color: #721c24; }
        /* å…¶é¤˜è¡¨æ ¼çœ‹æ¿æ¨£å¼ä¿ç•™... */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background-color: var(--cmd-dark); color: white; padding: 12px; text-align: left; cursor: pointer; font-size: 13px; position: relative; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
        .btn-edit { color: var(--cmd-blue); border: 1px solid var(--cmd-blue); background: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; }
        .btn-del { color: var(--cmd-red); border: 1px solid var(--cmd-red); background: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginPage" class="page active">
        <div class="login-box">
            <h2 style="color: var(--cmd-dark);">CMD ç³»çµ±ç™»å…¥</h2>
            <p style="color: #888; font-size: 14px; margin-bottom: 30px;">ğŸ” é›²ç«¯ç‹€æ…‹ï¼š<span id="loadStatus">æ­£åœ¨è®€å–...</span></p>
            <div class="login-input-group">
                <label>æ“ä½œèº«ä»½</label>
                <select id="userSelect" class="login-select">
                    <option value="é™³è¯ä½‘">é™³è¯ä½‘ (ç®¡ç†è€…)</option>
                    <option value="æå°‰å½¤">æå°‰å½¤</option>
                    <option value="ç„¦éºŸå‡±">ç„¦éºŸå‡±</option>
                    <option value="ç¾…å„„é©Š">ç¾…å„„é©Š</option>
                </select>
            </div>
            <div class="login-input-group">
                <label>ç™»å…¥å¯†ç¢¼</label>
                <input type="password" id="loginPassword" class="login-password" placeholder="è¼¸å…¥å¯†ç¢¼">
            </div>
            <button class="login-btn" id="loginBtn" onclick="handleLogin()">é€²å…¥ç³»çµ±</button>
            <p id="loginError" style="color: var(--cmd-red); font-size: 12px; margin-top: 15px; display: none;"></p>
        </div>
    </div>

    <div id="mainPage" class="page">
        <header>
            <h1 onclick="switchPage('main')" style="cursor:pointer">CMD é€²éŠ·å­˜ç³»çµ±</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span id="cloudStatus" class="status-ok">ğŸ“¡ é›²ç«¯é€£ç·šæ­£å¸¸</span>
                <div class="user-badge">ğŸ‘¤ <span id="displayUser">---</span></div>
                <button style="background-color: var(--cmd-purple); color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;" onclick="switchPage('package')">ğŸ“¦ å¥—é¤ç®¡ç†</button>
                <button onclick="logout()" style="color:#999; border:none; background:none; font-size:11px; cursor:pointer;">ç™»å‡º</button>
            </div>
        </header>
        <div id="categoryStats" style="margin-bottom:20px;"></div>
        <div class="filter-panel" style="background:#eee; padding:10px; border-radius:8px; margin-bottom:20px;">
            <input type="text" id="fSearch" placeholder="æœå°‹..." oninput="render()" style="padding:10px; width:300px; border-radius:6px; border:1px solid #ccc;">
            <button onclick="fetchCloudData()" style="padding:10px; cursor:pointer;">ğŸ”„ åˆ·æ–°</button>
        </div>
        <table id="recordTable"><thead><tr><th onclick="sortRecords('date')">æ—¥æœŸ</th><th>é¡å‹</th><th>åˆ†é¡</th><th>ä»£è™Ÿ</th><th>å“å</th><th>å–®åƒ¹</th><th>æ•¸é‡</th><th>æ“ä½œè€…</th><th>æ“ä½œ</th></tr></thead><tbody id="recordTableBody"></tbody></table>
    </div>

    <div id="packagePage" class="page">
        <div id="packageList"></div>
        <button onclick="switchPage('main')" style="margin-top:20px; padding:10px;">â† è¿”å›</button>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbw0D7JhhmP4NpK6RkTsT0btSbcbFqf5A5nefakMJT-YKCbHlOyr3l7WXSRC0XjhjkQ2TQ/exec";
    let currentUser = "", records = [], productInfo = {}, packages = [], sortConfig = { key: 'date', direction: 'desc' };

    window.onload = async () => {
        const loadStatus = document.getElementById('loadStatus');
        try {
            const response = await fetch(GAS_URL + "?action=loadAll&t=" + Date.now());
            if(response.ok) {
                loadStatus.innerText = "âœ… å·²å°±ç·’";
                loadStatus.style.color = "green";
            }
        } catch (e) {
            loadStatus.innerText = "âŒ é€£ç·šå¤±æ•—";
        }
    };

    async function handleLogin() {
        const user = document.getElementById('userSelect').value;
        const pass = String(document.getElementById('loginPassword').value).trim();
        const btn = document.getElementById('loginBtn');
        const error = document.getElementById('loginError');
        
        btn.innerText = "é©—è­‰ä¸­...";
        error.style.display = "none";
        
        try {
            const response = await fetch(GAS_URL + "?action=loadAll&t=" + Date.now());
            const data = await response.json();
            
            if (data.error) {
                alert("é›²ç«¯éŒ¯èª¤: " + data.error);
                btn.innerText = "é€²å…¥ç³»çµ±";
                return;
            }

            // å¼·åˆ¶æ¯”å°
            const found = data.users.find(u => String(u[0]).trim() === user && String(u[1]).trim() === pass);
            
            if (found) {
                currentUser = user;
                document.getElementById('displayUser').innerText = user;
                if(data.records && data.records.length > 1) {
                    records = data.records.slice(1).map(r => ({timestamp:r[0], date:r[1], type:r[2], category:r[3], id:String(r[4]), name:r[5], price:Number(r[6]), qty:Number(r[7]), operator:r[9]}));
                }
                if(data.packages) try { packages = JSON.parse(data.packages); } catch(e) {}
                switchPage('main');
            } else {
                error.innerText = "å¯†ç¢¼ä¸æ­£ç¢º"; error.style.display = "block"; btn.innerText = "é€²å…¥ç³»çµ±";
            }
        } catch (e) {
            error.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦"; error.style.display = "block"; btn.innerText = "é€²å…¥ç³»çµ±";
        }
    }

    function logout() { window.location.href = window.location.origin + window.location.pathname; }

    async function fetchCloudData() {
        const response = await fetch(GAS_URL + "?action=loadAll&t=" + Date.now());
        const data = await response.json();
        if(data.records && data.records.length > 1) records = data.records.slice(1).map(r => ({timestamp:r[0], date:r[1], type:r[2], category:r[3], id:String(r[4]), name:r[5], price:Number(r[6]), qty:Number(r[7]), operator:r[9]}));
        render();
    }

    async function pushToCloud() {
        await fetch(GAS_URL, {method: "POST", mode: "no-cors", body: JSON.stringify({action: "saveRecords", data: records, packages: JSON.stringify(packages)})});
        document.getElementById('cloudStatus').innerText = "âœ… åŒæ­¥æˆåŠŸ";
    }

    function render() {
        const tableBody = document.getElementById('recordTableBody');
        tableBody.innerHTML = '';
        let display = records.filter(r => {
            const q = document.getElementById('fSearch').value.toLowerCase();
            return !q || r.id.toLowerCase().includes(q) || r.name.toLowerCase().includes(q);
        });
        display.sort((a,b) => (a[sortConfig.key] < b[sortConfig.key] ? -1 : 1) * (sortConfig.direction === 'asc' ? 1 : -1));
        display.forEach(r => {
            const row = tableBody.insertRow();
            row.innerHTML = `<td>${r.date}</td><td>${r.type}</td><td>${r.category}</td><td>${r.id}</td><td>${r.name}</td><td>$${r.price}</td><td>${r.qty}</td><td>${r.operator}</td><td><button class="btn-del" onclick="delRec(${r.timestamp})">åˆª</button></td>`;
        });
    }

    function sortRecords(k) { if(sortConfig.key===k) sortConfig.direction=sortConfig.direction==='asc'?'desc':'asc'; else {sortConfig.key=k; sortConfig.direction='asc';} render(); }
    function switchPage(p) { document.querySelectorAll('.page').forEach(el => el.classList.remove('active')); document.getElementById(p + 'Page').classList.add('active'); render(); }
    function sync() { pushToCloud(); render(); }
    function delRec(ts) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { records = records.filter(r => r.timestamp !== ts); sync(); } }
</script>
</body>
</html>
